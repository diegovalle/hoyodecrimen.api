{% extends "base.html" %}
{% block title %}{{_('Charts of Crime in Mexico City')}}{% endblock %}
{% block lang %}{{_('en')}}{% endblock %}
{% block hreflang %}{{_('es')}}{% endblock %}
{% block alternhref %}{{_('https://hoyodecrimen.com/charts')}}{% endblock %}
{% block description %}{{_('Small multiple charts of crime in Mexico City')}}{% endblock %}

{% block css %}
{% assets  'css_pip_req'   %}
<link href="{{ ASSET_URL }}" rel="stylesheet" type="text/css">
{% endassets %}
{% endblock %}

{% block js %}
<script>
  // URL for the angular table
  anuglar_table_url = "/api/v1/sectores/crimes/all/top/rates"
</script>
{% assets  'js_pip_req'  %}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
{% endassets %}
{% endblock %}

{% block head %}
{{super()}}
{% endblock %}
{% block subscribe %}
{% endblock %}
{% block content %}

<!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
  <form action="//diegovalle.us6.list-manage.com/subscribe/post?u=787fae824c502d9f3ad7d0b73&amp;id=102491489b" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div class="center">
      <div>
        <span style="color:white;font-weight:bold;">{{_('Free email when new information is available')}}</span>
	<input type="email" value=" " size="30" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email" required>

        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_787fae824c502d9f3ad7d0b73_102491489b" tabindex="-1" value=""></div>
        <input type="submit" value="{{_('Subscribe')}}" name="subscribe" id="mc-embedded-subscribe" class="button" style="background:green;color:white;padding: .7em 2em;font-size: .9em;padding-bottom: 6px;">
    </div></div>
  </form>
</div>
<!--End mc_embed_signup-->

    <div id="small-multiples" class="row">
    </div>
<style>
.mg-chart-title {
  cursor: default;
  font-size: .7rem;
  padding-top: 0px;
  text-align: center;
  font-family: 'Open Sans', sans-serif, Arial;
  color: #111;
}
</style>
<script>
var filterCrime = function(data, sector) {
                   data = _.filter(data, { 'sector': sector });
                   data = MG.convert.date(data, 'date', '%Y-%m');
                   return(data)
               }
 $.ajax({
     dataType: 'jsonp',
     url: '/api/v1/sectores/all/crimes/HOMICIDIO DOLOSO/series',
     success: function(data) {
         //sectores = _.uniq(_.pluck(data.rows, 'sector'));
         _.forEach(data.rows, function(x) {x['rate'] = x.count / x.population * 100000 * 12});
         //sectors sorted by highest homicide rate
         groups=_.groupBy(data.rows, function(x) {return x.sector});
         red = _(groups).map(function(g, key) {
             return { sector: key,
                      rate: _(g).reduce(function(m,x) { return (m + x.rate)/2; }, 0) };
         });
         sectores = _.pluck(_.sortBy(red, "rate"), "sector").reverse();
         _.map(sectores, function(x) {
             if (document.getElementById('line' + x.replace(/ /g, '-').replace(/\./g, '-')) === null) {
                 $('<div id="'+ 'line' + x.replace(/ /g, '-').replace(/\./g, '-') +'" class="3u"></div>').appendTo('#small-multiples');
             }
         });

         max_rate = _.max(data.rows, 'rate')['rate'];
         var line_options = {
             //title: "Homicides",
             description: '',
             height: 150,
             y_label: '',
             max_y: max_rate,
             area: false,
             //full_width: true,
             width: 200,
             interpolate: "linear",
             target: '#homicidios',
             x_accessor: 'date',
             y_accessor: 'rate',
             xax_count: 4
         };

         _.forEach(sectores, function(x) {
             line_values = filterCrime(data.rows, x);
             line_options.data = line_values;
             line_options.title = x;
             line_options.target = "#line" + x.replace(/ /g, '-').replace(/\./g, '-');
             MG.data_graphic(line_options);
             return
         });
     }});
</script>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-hom.png')}}" >
<hr/>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-rncv.png')}}" >
<hr/>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-rvcv.png')}}" >
<hr/>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-rvsv.png')}}" >
<hr/>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-rtcv.png')}}" >
<hr/>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-rtsv.png')}}" >
<hr/>

<h2>{{_('Crime by Sector')}}</h2>
<img src="{{_('/images/total-sector-rccv.png')}}" >
<hr/>
{% endblock %}

{% block js_bottom %}
{% endblock %}
